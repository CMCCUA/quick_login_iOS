# 1. 开发环境配置 
sdk技术问题沟通QQ群：609994083
## 1.1. 环境配置及发布

1. 导入统一认证framework

直接将统一认证`TYRZSDK.framework`拖到项目中

![iOS-1](D:\$$ 统一认证\文档\1. 融合SDK开发文档\image\iOS-1.png)

2. 在Xcode中找到`TARGETS-->Build Setting-->Linking-->Other Linker Flags`在这选项中需要添加`-ObjC`

![iOS-4](D:\$$ 统一认证\文档\1. 融合SDK开发文档\image\iOS-4.jpg)

3. TARGETS-->Build Setting-->搜索框中搜索"BitCode"选项,并且将该选项的属性设置为NO

![iOS-5](D:\$$ 统一认证\文档\1. 融合SDK开发文档\image\iOS-5.jpg)

4.添加bundle资源包

TARGETS -->Build Phases -->Copy Bundle Resources --> 点击 "+" --> Add Other --> TYRZSDK.frameWork --> Resource.bundle -->
Open 即可



</br>

## 1.2. Hello 统一认证 

本节内容主要面向新接入统一认证的开发者，介绍快速集成统一认证的基本服务的方法。

### 1.2.1. 统一认证登录流程

![](image/19.png)

由流程图可知，业务客户端集成SDK后只需要完成2步集成实现登录

    1.	调用登录接口获取token
    2.	携带token请求登录

</br>

### 1.2.2. 统一认证登录集成步骤

**第一步：**

在appDelegate.m中的didFinish函数中添加初始化代码。初始化代码只需要执行一次就可以。

```objective-c
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    // Override point for customization after application launch.
     [TYRZUILogin initializeWithAppId:APPID appKey:APPKEY];
    return YES;
}
```

**第二步：**

在需要用到登录的地方调用登录接口即可，以下是预取号登录示例

```objective-c
/**
 预取号登录
 */
- (void)showImplicitLogin {
    [TYRZUILogin preGetPhonenumber:^(id sender) {
        NSNumber *result = sender[@"resultCode"];
        if (result.boolValue) {
            NSLog(@"预取号成功");
            [TYRZUILogin loginExplicitly:self complete:^(id sender) {
                NSLog(@"显示登录:%@",sender);
                NSString *resultCode = sender[@"resultCode"];
                self.token = sender[@"token"];
                NSMutableDictionary *result = [NSMutableDictionary dictionaryWithDictionary:sender];
                if ([resultCode isEqualToString:SUCCESSCODE
                     ]) {
                    result[@"result"] = @"获取token成功";
                } else {
                    result[@"result"] = @"获取token失败";
                }
                [self showInfo:result];
            }];
        } else {
            NSLog(@"预取号失败");
        }
    }];
}

```

<div STYLE="page-break-after: always;"></div>

#2. SDK方法描述

## 2.1. 初始化appid和appkey

### 2.1.1. 方法描述

**功能**

用于初始化appid、appkey设置。

**原型**

`TYRZBaseApi -> initializeWithAppId:appKey:`

```objective-c
+ (void)initializeWithAppId:(NSString *)appId appKey:(NSString *)appKey;
```

</br>

### 2.1.2. 参数说明

**请求参数**


| 参数     | 类型       | 说明       | 是否必填 |
| ------ | -------- | -------- | ---- |
| appID  | NSString | 应用的appid | 是    |
| appKey | NSString | 应用密钥     | 是    |



**响应参数**

无

</br>

### 2.1.3. 示例

**请求示例代码**

```objective-c
[TYRZUILogin initializeWithAppId:APPID appKey:APPKEY];
```



**响应示例代码**

无

</br>

## 2.2. 预取号登录


### 2.2.1. 方法描述

**功能**

使用SDK登录前，可以通过预取号方法提前获取用户信息并缓存。用户使用一键登录时，会优先使用缓存的信息快速请求SDK服务端获取`token`和`用户ID(openID)`等信息。提高登录速度，缓存的有效时间是5min并且只能使用一次。


**原型**

`TYRZUILogin -> preGetPhonenumber:complete`

```objective-c
+ (void)preGetPhonenumber:(void (^)(id sender))complete 
```

</br>

### 2.2.2. 参数说明

**请求参数**

无

**响应参数**

| 参数         | 类型         | 说明       | 是否必填 |
| ---------- | ---------- | -------- | ---- |
| resultCode | NSUinteger | 返回相应的结果码 | 是    |
| desc       | NSString   | 调用描述     | 是    |

</br>

### 2.2.3. 示例

**请求示例代码**

```objective-c
- (void)showSMSCodeLogin {

    [TYRZUILogin preGetPhonenumber:^(id sender) {
        NSString *resultCode = sender[@"resultCode"];
        NSMutableDictionary *result = [NSMutableDictionary dictionaryWithDictionary:sender];
        if ([resultCode isEqualToString:CLIENTSUCCESSCODECLIENT]) {
            NSLog(@"预取号成功");
        } else {
            NSLog(@"预取号失败");
        }
        [self showInfo:result];
    }];
    
}
```

</br>

**响应示例代码**

```
{
    resultCode = 103000;
    desc = "success"
}
```

</br>

## 2.3. 显式登录

### 2.3.1. 方法描述

**功能**

SDK自动弹出登录缓冲界面（图一，<font  style="color:blue; font-style:italic;">预取号成功将不会弹出缓冲页</font>），同时自动获取本机号码；若获取本机号码成功，自动切换到授权登录页面（图二），用户授权登录后，即可使用本机号码进行登录；若用户获取本机号码失败，自动跳转到短信验证码登录页面（图三，<font  style="color:blue; font-style:italic;">开发者可以选择是否跳到SDK提供的短信验证页面</font>），引导用户使用短信验证码登录。

![](image/ios-2.png)

</br>

**原型**

`TYRZUILogin -> getTokenExpWithController:complete:`

```objective-c
+ (void)getTokenExpWithController:(UIViewController *)vc
                         complete:(void (^)(id sender))complete;
```

</br>

### 2.3.2. 参数说明

**请求参数**

| 参数       | 类型               | 说明          | 是否必填 |
| -------- | ---------------- | ----------- | ---- |
| vc       | UIViewController | 调用显式登录所在的vc | 是    |
| complete | UAFinishBlock    | 登录回调        | 是    |

</br>

**响应参数**

| 参数          | 类型       | 说明                                       | 是否必填  |
| ----------- | -------- | ---------------------------------------- | ----- |
| resultCode  | NSString | 返回相应的结果码                                 | 是     |
| token       | NSString | 成功时返回：临时凭证                               | 成功时必填 |
| openID      | NSString | 成功时返回：用户身份唯一标识                           | 成功时必填 |
| authType    | NSString | 认证类型：0:其他；</br>1:WiFi下网关鉴权；</br>2:网关鉴权；</br>3:短信上行鉴权；</br>7:短信验证码登录 | 成功时必填 |
| authTypeDes | NSString | 认证类型描述，对应authType                        | 成功时必填 |
| desc        | NSString | 调用描述                                     | 否     |

</br>

### 2.3.3. 示例

**请求示例代码**

```objective-c
//显式登录
- (void)showExplicitlyLogin {
     __weak typeof(self) weakSelf = self;
    [TYRZUILogin getTokenExpWithController:weakSelf
                                  complete:^(id sender) {
                                        NSString *resultCode = sender[@"resultCode"];
                                        if ([resultCode isEqualToString:@"103000"]){ //返回成功执行的分支
                                           //显式登录成功返回token
                                           self.token = sender[@"token"]; 
                                        }       
                                    }];
}
```

</br>

**响应示例代码**

```
{
    authType = "1";
    authTypeDesc = "WIFI网关鉴权";
    openid = 1918310031;
    resultCode = 103000;
    token = 84840100013202003A4E45564452444D794E7A6C474E45557A4F4441314D304E4340687474703A2F2F3132302E3139372E3233352E32373A383038302F72732F403032030004030DF69E040012383030313230313730383137313031343230FF0020C8C9629B915C41DC3C9528E5D5796BB1551F2A49F8FCF7B5BA23ED0F28A8FAE9;
}
```

</br>

## 2.4. 隐式登录

### 2.4.1. 方法描述

**功能**

本方法用于实现本机号码校验功能。开发者通过隐式登录方法，无授权弹窗，可获取到token和openID，应用服务端凭token向SDK服务端请求校验是否本机号码。隐式取号失败后，不支持短信上行和短信验证码二次验证功能。

**原型**

`TYRZUILogin -> getTokenImpWithComplete:`

```objective-c

+ (void)getTokenImpWithComplete:(void (^)(id sender))complete

```

**请求参数**

无

**响应参数**

| 参数          | 类型       | 说明                                       | 是否必填  |
| ----------- | -------- | ---------------------------------------- | ----- |
| resultCode  | NSString | 返回相应的结果码                                 | 是     |
| token       | NSString | 成功时返回：临时凭证                               | 成功时必填 |
| authType    | NSString | 认证类型：0:其他；</br>1:WiFi下网关鉴权；</br>2:网关鉴权；</br>3:短信上行鉴权；</br>7:短信验证码登录 | 成功时必填 |
| authTypeDes | NSString | 认证类型描述，对应authType                        | 成功时必填 |
| OpenID      | NSString | 用户身份唯一标识。                                | 成功返回  |



## 2.5. 短信验证码页面登录开关

### 2.5.1. 方法描述

**功能**

该方法用于配置是否打开SDK自带的短信验证码服务，默认短信验证码服务是打开状态。SDK在两种情况会使用短信验证码登录：1、一键登录（网关取号）失败后，自动跳转到短验页面；2、在授权页面手机号码后面切换账号（见下图）后，用户可以选择使用非本机号码通过短信验证码登录账号。当该方法的属性设置为NO时，一键登录失败后将不会跳转到SDK自带的短信验证码页面，但用户点击切换账号时，也可以跳转到SDK自带的短信验证码页面。

![授权页](image\授权页.png)

</br>

**原型**

`TYRZUILogin -> setCustomSMS`

```objective-c

+ (void)enableCustomSMS:(BOOL)flag;

```

</br>

### 2.5.2. 参数说明

**请求参数**

| 参数     | 类型   | 说明                                       | 是否必填   |
| ------ | ---- | ---------------------------------------- | ------ |
| enable | BOOL | YES时显式登录取号失败会跳转至短信验证码界面</br>NO时显式登录取号失败不会跳转到短信验证码界面，但可以切换账号登录。切换账号按钮只受UAPageContentAccountSwitch控制，开发者可以传入按钮对象自行控制 | 是</br> |

**响应参数**

无

</br>

### 2.5.3. 示例

**请求示例代码**

```objective-c
  [TYRZUILogin enableCustomSMS:YES];
     __weak typeof(self) weakSelf = self;
    [TYRZUILogin getTokenExpWithController:weakSelf
                                  complete:^(id sender) {
                                        NSString *resultCode = sender[@"resultCode"];
                                        if ([resultCode isEqualToString:@"103000"]){ //返回成功执行的分支
                                           //显式登录成功返回token
                                           self.token = sender[@"token"]; 
                                        }       
                                    }];
```

</br>

**响应示例代码**

设置逻辑不返回

## 2.6. 用户自定义UI

SDK**登录授权页**和**短信验证码页面**部分元素可供开发者编辑，如开发者不需自定义，则使用SDK提供的默认样式，默认样式和编辑规则如下图所示：

![授权页](image\auth-page.png)

![授权页](image\sms-page.png)

### 2.6.1. 方法说明

**功能**

用户可以自定义自己的登录标题，如下图1内容

**原型**
`TYRZUILogin -> customUIWithParams:customViews:`

```objective-c
+ (void)customUIWithParams:(NSDictionary *)customUIParams
               customViews:(void(^)(NSDictionary *customAreaView))customViews;
```

### 2.6.2. 参数说明

**请求参数**

| 参数             | 类型                                    | 说明            | 是否必填 |
| -------------- | ------------------------------------- | ------------- | ---- |
| customUIParams | NSDictionary                          | 用户自己的自定义的UI属性 | 否    |
| customViews    | void(^)(NSDictionary *customAreaView) | 用户需要添加的自定义视图  | 否    |

**响应参数**

无

**customUIParams参数结构**

| 键名称          | 值类型  |  使用说明 | 是否可嵌套       | 所属层级 |
| -------------- | ------------------------------------- | ------------- | ---- | ---- |
| UAOneKeyPage | NSDictionary | 表示本机号码一键登录页面 | 否 | 1 |
| UAQuickPage | NSDictionary | 表示短信验证码页面 | 否 | 1 |
| UAPageNavLeftLogo | UIImage | 用户自定导航栏返回图标 | 否 | 1 |
| UAPageNavBackgroundColor | UIColor | 用户自定义导航栏颜色 | 否 | 1 |
| UAPageNavTitle | NSString | 用户自定义导航栏标题，可单独针对其中一个页面设置 | 是 | 1或者2 |
| UAPageNavRightItem | UIButton | 用户自定义导航栏右侧标题，设置在其中一个页面的右上角，如需全部页面设置，则要分别嵌套在两个页面的key中| 是 | 2 |
| UAPageContentLogo | UIImage | 用户自定义logo（建议最低像素：80x80），默认为中移动logo | 是 | 1或者2 |
| UAPageContentPhoneNumberBGColor | UIColor | 用户自定义号码区域底色 | 是 | 2 |
| UAPageContentSMSCodeBGColor | UIColor | 用户自定义短信输入框底色 | 是 | 2（如需自定义，必须嵌套在UAQuickPage）|
| UAPageContentAccountSwitchHidden | NSNumber | 用户控制切换账号显示或隐藏，YES隐藏，NO显示 | 是 | 2（如需自定义，必须嵌套在UAOneKeyPage）|
| UAPageContentLoginButtonBGColor | UIColor | 用户自定义登录按钮的底色 | 是 | 2 |
| UAPageContentLoginButtonBGImage | UIImage | 用户自定义登录按钮背景图 | 是 | 2 |
| UAPageContentLoginButtonCornerRadius | NSNumber | 用户自定义登录按钮圆角（只针对按钮的高）| 是 | 2 |
| UAPageContentLoginButtonTitleFont | UIFont | 用户自定义登录按钮字体风格和大小 | 是 | 2 |
| UAPageContentLoginButtonTitleColor | UIColor | 用户自定义登录按钮字体颜色 | 是 | 2 |
| UAPageContentSeperatorHidden | NSNumber | 用户控制logo下分割线的显示或隐藏，YES隐藏，NO显示 | 是 | 2 |


**使用示例**

``` objective-c

    UIButton *navRightButton = [UIButton buttonWithType:UIButtonTypeSystem];
    [navRightButton setTitle:@"注册" forState:UIControlStateNormal];
    [navRightButton sizeToFit];
    [navRightButton addTarget:self action:@selector(reigsterButtonAction:) forControlEvents:UIControlEventTouchUpInside];
    
    NSString *path = [NSBundle.mainBundle pathForResource:@"(Left_Arrow)_SFont.CN.png" ofType:nil];
    UIImage *leftLogo = [UIImage imageWithContentsOfFile:path];
    
    //以下字典结构如果需要自定义元素应用到每个页面，则把元素的键名写在第一层，第二层的元素键名则只显示在特定的页面
    NSDictionary *uiParams = @{
                               
                               UAPageNavLeftLogo:leftLogo, //自定义导航栏返回的logo
                               UAOneKeyPage:@{
                                       
                                       UAPageNavRightItem:navRightButton, //自定义导航栏右侧返回按钮（只显示在一键登录页）
                                       UAPageContentSeperatorHidden:@(NO), //控制logo下分割线显示或者隐藏（只隐藏一键登录页的分割线）
                                       
                                       },
                               
                               };
    
    [TYRZUILogin customUIWithParams:uiParams customViews:^(NSDictionary *customAreaView) {
        
//此处将自定义的视图加进对应页面的View
        if (customAreaView[UAOneKeyPage]) { //UAOneKeyPage为一键登录页面的键名（只显示一个手机号码，无验证码输入）
            
            UIView *oneKeyView = customAreaView[UAOneKeyPage];
            
            [self customShareButtonsWithView:oneKeyView];
        }
        
        if (customAreaView[UAQuickPage]) { //UAQuickPage为验证码页面的键名（可输入手机号和短信验证码）
            
            UIView *quickPageView = customAreaView[UAQuickPage];
            
            [self customShareButtonsWithView:quickPageView];
        }
        
    }];

```

<div STYLE="page-break-after: always;"></div>

# 3. 平台接口说明

## 3.1. 获取用户信息接口

### 3.1.1. 接口说明

**功能**

业务平台或服务端携带用户授权成功后的token来调用统一认证服务端获取用户信息。

**请求地址：** https://www.cmpassport.com/unisdk/rsapi/loginTokenValidate

**协议：** HTTPS 

**请求方法：** POST+json

**回调地址：**请参考开发者接入流程文档

</br>

### 3.1.2. 参数说明

**请求参数**

| 参数           |  层级  |   类型   |  约束  | 说明                                       |
| :----------- | :--: | :----: | :--: | :--------------------------------------- |
| version      |  1   | string |  必选  | 填2.0                                     |
| msgid        |  1   | string |  必选  | 标识请求的随机数即可(1-36位)                        |
| systemtime   |  1   | string |  必选  | 请求消息发送的系统时间，精确到毫秒，共17位，格式：20121227180001165 |
| strictcheck  |  1   | string |  必选  | 验证源ip合法性，填写”1”，统一认证会校验sourceid与出口ip对应关系（ip 地址的配置方法请参考接入流程文档) |
| appid        |  1   | string |  必选  | 业务在统一认证申请的应用id                           |
| expandparams |  1   | string | 扩展参数 | map(key,value)                           |
| token        |  1   | string |  必选  | 需要解析的凭证值。                                |
| sign         |  1   | string |  必选  | 签名，MD5（appid + version + msgid + systemtime + strictcheck + token + appkey)（注：“+”号为合并意思，不包含在被加密的字符串中） |

</br>

**响应参数**

| 参数           | 层级   | 类型     | 约束   | 说明                                       |
| ------------ | ---- | ------ | ---- | ---------------------------------------- |
| inresponseto | 1    | string | 必选   | 对应的请求消息中的msgid                           |
| systemtime   | 1    | string | 必选   | 响应消息发送的系统时间，精确到毫秒，共17位，格式：20121227180001165 |
| resultcode   | 1    | string | 必选   | 返回码                                      |
| msisdn       | 1    | string | 可选   | 表示手机号码                                   |
| authtype     | 1    | string | 可选   | 认证方式：</br>WAPGW:网关鉴权；</br>SMSGW:短信验证码鉴权；</br>UPAndPassport:Wifi网关鉴权 |


</br>

### 3.1.3. 示例

**请求示例**

```
{
    "strictcheck": "1",
    "version": "2.0",
    "msgid": "40a940a940a940a93b8d3b8d3b8d3b8d",
    "systemtime": "20170515090923489",
    "appid": "10000001",
    "token": "XXXXXXXXXXXXXX",
    "sign": "dfdiopurteinekw"
}
```

**响应示例**

```
{
    "resultcode": "103000",
    "inresponseto": "40a940a940a940a93b8d3b8d3b8d3b8d",
    "userid": "000000000",
    "pcid": "0000000",
    "msisdn": "13683329795",
    "systemtime": "20170522204845598"
}
```

<div STYLE="page-break-after: always;"></div>

# 4. 返回码说明

## 4.1. SDK返回码

使用SDK时，SDK会在认证结束后将结果回调给开发者，其中结果为JSONObject对象，其中resultCode为结果响应码，103000代表成功，其他为失败。成功时在根据token字段取出身份标识。失败时根据resultCode定位失败原因。

| 错误编号   | 返回码描述                                    |
| ------ | ---------------------------------------- |
| 103000 | 成功                                       |
| 102101 | 无网络                                      |
| 102102 | 网络异常                                     |
| 102103 | 非移动网络                                    |
| 102109 | 网络错误                                     |
| 102201 | 自动登陆失败，用户选择自定义界面时，需要继续处理手动登陆流程，比如弹出登陆界面。 |
| 102202 | APP签名验证不通过                               |
| 102203 | 接口入参错误                                   |
| 102204 | 正在进行GetToken动作，请稍后                       |
| 102205 | 当前环境不支持指定的登陆方式                           |
| 102206 | 选择用户登陆时，本地不存在指定的用户                       |
| 102207 | 获取的中间件值错误                                |
| 102208 | 参数错误                                     |
| 102209 | 没有sim卡                                   |
| 102210 | 不支持短信发送                                  |
| 10299  | 其他错误                                     |
| 102301 | 用户取消                                     |
| 102302 | 没有进行初始化参数                                |
| 102303 | 用户名为空                                    |
| 102304 | 密码为空                                     |
| 102305 | 验证码获得成功                                  |
| 102306 | 验证码获得失败                                  |
| 102307 | 用户名格式错误                                  |
| 102308 | 用户名格式错误                                  |
| 102309 | 验证码格式错误                                  |
| 102310 | 用户名和验证码格式错误                              |
| 102311 | 密码格式错误                                   |
| 102312 | 用户名和密码格式错误                               |
| 200002 | 手机未安装SIM卡                                |
| 200009 | Bundle Id与服务器填写的不一致                      |
</br>

## 4.2. 平台返回码

| 错误编号   | 返回码描述                |
| ------ | -------------------- |
| 103000 | 成功                   |
| 103101 | 签名错误                 |
| 103103 | 用户不存在                |
| 103104 | 用户不支持该种登录方式          |
| 103105 | 密码错误                 |
| 103106 | 用户名错误                |
| 103107 | 已存在相同的随机数            |
| 103108 | 短信验证码错误              |
| 103109 | 短信验证码超时              |
| 103111 | WAP网关IP不合法           |
| 103112 | 请求错误 reqError        |
| 103113 | Token内容错误            |
| 103114 | token验证 KS过期         |
| 103115 | token验证 KS不存在        |
| 103116 | token验证 sqn错误        |
| 103117 | mac异常 macError       |
| 103118 | sourceid不存在          |
| 103119 | appid不存在appidNOExist |
| 103120 | clientauth不存在        |
| 103121 | openid不存在            |
| 103122 | btid不存在              |
| 103123 | redisinfo不存在         |
| 103124 | ksnaf校验不一致           |
| 103125 | 手机格式错误               |
| 103126 | 手机号不存在               |
| 103127 | 证书验证，版本过期            |
| 103128 | gba webservice接口调用失败 |
| 103129 | 获取短信验证码的msgtype异常    |
| 103130 | 新密码不能与当前密码相同         |
| 103131 | 密码过于简单               |
| 103132 | 用户注册失败               |
| 103133 | sourceid不合法          |
| 103134 | wap方式手机号为空           |
| 103135 | 昵称非法                 |
| 103136 | 邮箱非法                 |
| 103138 | appid已存在             |
| 103139 | sourceid已存在          |
| 103200 | 不需要更新ks              |
| 103204 | 缓存随机数不存在             |
| 103205 | 服务器内部异常              |
| 103207 | 发送短信失败               |
| 103212 | 校验密码失败               |
| 103213 | 旧密码错误                |
| 103214 | 访问缓存或数据库错误           |
| 103226 | sqn过小或过大             |
| 103265 | 用户已存在                |
| 103901 | 短信验证码下发次数已达上限        |
| 103902 | 凭证校验失败               |
| 103911 | 获取token过于频繁          |
| 104001 | APPID和APPKEY已存在      |
| 105001 | 联通网关取号失败             |
| 105002 | 移动网关取号失败             |
| 105003 | 电信网关取号失败             |
| 105004 | 短信上行ip检测不合法          |
| 105005 | 短信上行发送信息为空           |
| 105006 | 手机号码为空               |
| 105007 | 手机号码格式错误             |
| 105008 | 短信内容为空               |
| 105009 | 解析失败                 |
| 105010 | phonescript失效或者非法    |
| 105012 | 不支持电信取号              |
| 105013 | 不支持联通取号              |
| 105019 | 应用未授权                |
