??????
# 1. 开发环境配置 

## 1.1. 环境配置及发布

1. 导入统一认证framework

直接将统一认证`TYRZSDK.framework`拖到项目中

![iOS-1](D:\$$ 统一认证\文档\1. 融合SDK开发文档\image\iOS-1.png)

2. 在Xcode中找到`TARGETS-->Build Setting-->Linking-->Other Linker Flags`在这选项中需要添加`-ObjC`

![iOS-4](D:\$$ 统一认证\文档\1. 融合SDK开发文档\image\iOS-4.jpg)

3. TARGETS-->Build Setting-->搜索框中搜索"BitCode"选项,并且将该选项的属性设置为NO

![iOS-5](D:\$$ 统一认证\文档\1. 融合SDK开发文档\image\iOS-5.jpg)

</br>

## 1.2. Hello 统一认证 

本节内容主要面向新接入统一认证的开发者，介绍快速集成统一认证的基本服务的方法。

### 1.2.1. 统一认证登录流程

![](image/android/19.png)

由流程图可知，业务客户端集成SDK后只需要完成2步集成实现登录

    1.	调用登录接口获取token
    2.	携带token请求登录

</br>

### 1.2.2. 统一认证登录集成步骤

**第一步：**

在appDelegate.m中的didFinish函数中添加初始化代码。初始化代码只需要执行一次就可以。

```objective-c
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    // Override point for customization after application launch.
     [TYRZBaseApi customInit:APPID appKey:APPKEY sourceID:SOURCEID];
    return YES;
}
```

**第二步：**

在需要用到登录的地方调用登录接口即可，以下是预取号登录示例

```objective-c
/**
 预取号登录
 */
- (void)showImplicitLogin {
    [TYRZUILogin preGetPhonenumber:^(id sender) {
        NSNumber *result = sender[@"resultCode"];
        if (result.boolValue) {
            NSLog(@"预取号成功");
            [TYRZUILogin loginExplicitly:self complete:^(id sender) {
                NSLog(@"显示登录:%@",sender);
                NSString *resultCode = sender[@"resultCode"];
                self.token = sender[@"token"];
                NSMutableDictionary *result = [NSMutableDictionary dictionaryWithDictionary:sender];
                if ([resultCode isEqualToString:SUCCESSCODE
                     ]) {
                    result[@"result"] = @"获取token成功";
                } else {
                    result[@"result"] = @"获取token失败";
                }
                [self showInfo:result];
            }];
        } else {
            NSLog(@"预取号失败");
        }
    }];
}

```

<div STYLE="page-break-after: always;"></div>

#2. SDK方法描述

## 2.1. 初始化appid和appkey

### 2.1.1. 方法描述

**功能**

用于初始化appid、appkey设置。



**原型**

`TYRZBaseApi -> customInit:appKey:sourceID:`

```objective-c
+ (void)customInit:(NSString *)appID appKey:(NSString *)appKey sourceID:(NSString *)sourceID;
```

</br>

### 2.1.2. 参数说明

**请求参数**


| 参数       | 类型       | 说明       | 是否必填 |
| -------- | -------- | -------- | ---- |
| appID    | NSString | 应用的appid | 是    |
| appKey   | NSString | 应用密钥     | 是    |
| sourceID | NSString | 业务ID     | 是    |



**响应参数**

无

</br>

### 2.1.3. 示例

**请求示例代码**

```objective-c
 [TYRZBaseApi customInit:APPID appKey:APPKEY sourceID:SOURCEID];
```



**响应示例代码**

无

</br>

## 2.2. 短信验证码登录


### 2.2.1. 方法描述

**功能**

用于使用短信验证码登录，客户端单独调起SDK的短信验证码登录界面（下图），用户手动输入电话号码，获取短信验证码登录，登录成功后获取token和用户ID等。业务方如果需要获取用户的手机号码，需再次调取3.1接口来换取用户的手机号码等信息。

![ios-06](D:\$$ 统一认证\文档\1. 融合SDK开发文档\image\ios-06.jpeg)



**原型**

`TYRZUILogin -> loginSMS:complete:`

```objective-c
+ (void)loginSMS:(UIViewController *)vc complete:(void (^)(id sender))complete;
```

</br>

### 2.2.2. 参数说明

**请求参数**

| 参数       | 类型               | 说明             | 是否必填 |
| -------- | ---------------- | -------------- | ---- |
| vc       | UIViewController | 调用短信验证码登录所在的vc | 是    |
| complete | UAFinishBlock    | 登录回调           | 是    |

</br>

**响应参数**

| 参数          | 类型         | 说明                   | 是否必填  |
| ----------- | ---------- | -------------------- | ----- |
| resultCode  | NSUinteger | 返回相应的结果码             | 是     |
| token       | NSString   | 登录时需要的token          | 成功时必填 |
| openid      | NSString   | 和通行证ID               | 成功时必填 |
| authType    | NSString   | 认证类型(详见附录1 认证方法标识)   | 成功时必填 |
| authTypeDes | NSString   | 认证类型描述(详见附录1 认证方法标识) | 成功时必填 |
| desc        | NSString   | 调用描述                 | 否     |

</br>

### 2.2.3. 示例

**请求示例代码**

```objective-c
- (void)showSMSCodeLogin {
    [TYRZUILogin loginSMS:self complete:^(id sender) {
        NSLog(@"=open=短信验证码登录:%@",sender);
        NSString *resultCode = sender[@"resultCode"];
        self.token = sender[@"token"];
        NSMutableDictionary *result = [NSMutableDictionary dictionaryWithDictionary:sender];
        if ([resultCode isEqualToString:SUCCESSCODE]) {
            result[@"result"] = @"获取token成功";
        } else {
            result[@"result"] = @"获取token失败";
        }
        [self showInfo:result];
    }];
}
```

</br>

**响应示例代码**

```
{
    openid = 1918310031;
    resultCode = 103000;
    token = 84840100013202003A517A424352446B34517A63304D45464751544E464E6A6B3040687474703A2F2F3132302E3139372E3233352E32373A383038302F72732F40303103000403D6A9B1040012383030313230313730383137313031343230FF00209FEDE8882EDD17B521BC36C422F264925383659BE7AFDFB1BB01958AD9AFC080;
    userName = "139****0743";
}
```

</br>

## 2.3. 显式登录

### 2.3.1. 方法描述

**功能**

用于显式登录。SDK自动调起登录等待界面（图一），同时自动获取本机号码；若获取本机号码成功，自动切换到授权登录页面（图二），用户授权登录后，即可使用本机号码进行登录；若用户获取本机号码失败，自动跳转到短信验证码登录页面（图三），引导用户使用短信验证码登录；

![iOS-2](D:\$$ 统一认证\文档\1. 融合SDK开发文档\image\iOS-2.png)

</br>

**原型**

`TYRZUILogin -> loginExplicitly:complete:`

```objective-c
+ (void)loginExplicitly:(UIViewController *)vc complete:(void (^)(id sender))complete;
```

</br>

### 2.3.2. 参数说明

**请求参数**

| 参数       | 类型               | 说明          | 是否必填 |
| -------- | ---------------- | ----------- | ---- |
| vc       | UIViewController | 调用显式登录所在的vc | 是    |
| complete | UAFinishBlock    | 登录回调        | 是    |

</br>

**响应参数**

| 参数          | 类型         | 说明                   | 是否必填  |
| ----------- | ---------- | -------------------- | ----- |
| resultCode  | NSUinteger | 返回相应的结果码             | 是     |
| token       | NSString   | 登录时需要的token          | 成功时必填 |
| openid      | NSString   | 和通行证ID               | 成功时必填 |
| authType    | NSString   | 认证类型(详见附录1 认证方法标识)   | 成功时必填 |
| authTypeDes | NSString   | 认证类型描述(详见附录1 认证方法标识) | 成功时必填 |
| desc        | NSString   | 调用描述                 | 否     |

</br>

### 2.3.3. 示例

**请求示例代码**

```objective-c
//显式登录
- (void)showExplicitlyLogin {
     __weak typeof(self) weakSelf = self;
    [TYRZUILogin loginExplicitly:weakSelf complete:^(id sender) {
        dispatch_async(dispatch_get_main_queue(), ^{
            NSString *resultCode = sender[@"resultCode"];
            self.token = sender[@"token"];
            NSMutableDictionary *result = [NSMutableDictionary dictionaryWithDictionary:sender];
            if ([resultCode isEqualToString:SUCCESSCODE]) {
                result[@"result"] = @"获取token成功";
            } else {
                result[@"result"] = @"获取token失败";
            }
            [self showInfo:result];
        });
    }];
}
```

</br>

**响应示例代码**

```
{
    desc = "\U767b\U5f55\U6210\U529f";
    openid = 1918310031;
    resultCode = 103000;
    token = 84840100013202003A4E45564452444D794E7A6C474E45557A4F4441314D304E4340687474703A2F2F3132302E3139372E3233352E32373A383038302F72732F403032030004030DF69E040012383030313230313730383137313031343230FF0020C8C9629B915C41DC3C9528E5D5796BB1551F2A49F8FCF7B5BA23ED0F28A8FAE9;
    userName = 13902220743;
}
```

</br>

## 2.4. 显式登录失败后使用短信验证码登录开关

### 2.4.1. 方法描述

**功能**

显式登录调取失败后，可使用该方法来决定是否使用短信验证码登录，短验流程同2.4。

</br>

**原型**

`TYRZUILogin -> setCustomSMS`

```objective-c
+ (void)setCustomSMS:(BOOL)enable;
```

</br>

### 2.4.2. 参数说明

**请求参数**

| 参数     | 类型   | 说明                      | 是否必填 |
| ------ | ---- | ----------------------- | ---- |
| enable | BOOL | YES时显示登录取号失败会跳转至短信验证码界面 | 是    |

</br>

**响应参数**

无

</br>

### 2.4.3. 示例

**请求示例代码**

```objective-c
  [TYRZUILogin setCustomSMS:YES];
     __weak typeof(self) weakSelf = self;
    [TYRZUILogin loginExplicitly:weakSelf complete:^(id sender) {
        dispatch_async(dispatch_get_main_queue(), ^{
            NSString *resultCode = sender[@"resultCode"];
            self.token = sender[@"token"];
            NSMutableDictionary *result = [NSMutableDictionary dictionaryWithDictionary:sender];
            if ([resultCode isEqualToString:SUCCESSCODE]) {
                result[@"result"] = @"获取token成功";
            } else {
                result[@"result"] = @"获取token失败";
            }
            [self showInfo:result];
        });
    }];
```

</br>

**响应示例代码**

设置逻辑不返回

## 2.5. 用户可以自定义登录标题

### 2.5.1. 方法说明

**功能**

用户可以自定义自己的登录标题

**原型**
`TYRZUILogin -> loginEximplicit`

```objective-c
+ (void)setLoginTitle:(NSString *)loginTitle;
```

### 2.5.2. 参数说明

**请求参数**

| 参数         | 类型       | 说明            | 是否必填 |
| ---------- | -------- | ------------- | ---- |
| loginTitle | NSString | 用户自己的自定义的登录标题 | 是    |

**响应参数**

无

## 2.6.  用户可以自定义Logo

### 2.6.1. 方法说明

**功能**
用户自定义的登录logo
**原型**
`TYRZUILogin -> loginEximplicit`

```objective-c
+ (void)setLogo:(UIImage *)image;
```

### 2.6.2. 参数说明

**请求参数**

| 参数    | 类型      | 说明           | 是否必填 |
| ----- | ------- | ------------ | ---- |
| image | UIImage | 用户自定义的登录logo | 是    |

**响应参数**

无

<div STYLE="page-break-after: always;"></div>

# 3. 平台接口说明

## 3.1. 获取用户信息接口

### 3.1.1. 接口说明

**功能**

业务平台或服务端携带用户授权成功后的token来调用统一认证服务端获取用户信息。

**请求地址：** https://www.cmpassport.com/unisdk/rsapi/tokenValidate

**协议：** HTTPS 

**请求方法：** POST+json

**回调地址：**请参考开发者接入流程文档中`配置业务服务端地址`相关操作

</br>

### 3.1.2. 参数说明

**请求参数**

| 参数            |  层级  |   类型   |  约束  | 说明                                       |
| :------------ | :--: | :----: | :--: | :--------------------------------------- |
| header        |  1   |        |  必选  |                                          |
| version       |  2   | string |  必选  | 填1.0                                     |
| msgid         |  2   | string |  必选  | 标识请求的随机数即可(1-36位)                        |
| systemtime    |  2   | string |  必选  | 请求消息发送的系统时间，精确到毫秒，共17位，格式：20121227180001165 |
| strictcheck   |  2   | string |  必选  | 验证源ip合法性，填写”1”，统一认证会校验sourceid与出口ip对应关系（ip 地址的配置方法请参考接入流程文档中`配置业务服务端地址`相关操作) |
| sourceid      |  2   | string |  可选  | 业务集成统一认证的标识，应用接入后可获取                     |
| ssotosourceid |  2   | string |  可选  | 单点登录时使用，填写被登录业务的sourceid                 |
| appid         |  2   | string |  可选  | 业务在统一认证申请的应用id                           |
| apptype       |  2   | string |  可选  | 1:BOSS<br />2:web<br />3:wap<br />4:pc客户端<br />5:手机客户端 |
| expandparams  |  2   | string | 扩展参数 | map(key,value)                           |
| body          |  1   |        |  可选  |                                          |
| token         |  2   | string |  可选  | 需要解析的凭证值。                                |

</br>

**响应参数**

| 参数                  | 层级   | 类型     | 约束   | 说明                                       |
| ------------------- | ---- | ------ | ---- | ---------------------------------------- |
| header              | 1    |        | 必选   |                                          |
| version             | 2    | string | 必选   | 1.0                                      |
| inresponseto        | 2    | string | 必选   | 对应的请求消息中的msgid                           |
| systemtime          | 2    | string | 必选   | 响应消息发送的系统时间，精确到毫秒，共17位，格式：20121227180001165 |
| resultcode          | 2    | string | 必选   | 返回码                                      |
| body                | 1    |        | 必选   |                                          |
| pcid                | 2    | string | 必选   | 伪码id                                     |
| usessionid          | 2    | string | 可选   | 暂忽略                                      |
| openid              | 2    | string | 可选   | 用户统一账号的系统标识                              |
| andid               | 2    | string | 可选   | 用户的“和ID”                                 |
| msisdn              | 2    | string | 可选   | 表示手机号码                                   |
| email               | 2    | string | 可选   | 表示邮箱地址                                   |
| loginidtype         | 2    | string | 可选   | 登录使用的用户标识：<br />0:手机号码<br />1：邮箱         |
| msisdntype          | 2    | string | 可选   | 手机号码的归属运营商<br />0:中国移动<br />1:中国电信<br />2:中国联通<br />99:未知的异网手机号码 |
| province            | 2    | string | 可选   | 用户所属省份(暂无)                               |
| authtype            | 2    | string | 可选   | 认证方式，取值参见附录1 认证方法标识                      |
| authtime            | 2    | string | 可选   | 统一认证平台认证用户的时间                            |
| lastactivetime      | 2    | string | 可选   | 暂无                                       |
| relateToAndPassport | 2    | string | 可选   | 是否已经关联到统一账号，暂无用处                         |
| fromsourceid        | 2    | string | 可选   | 来源sourceid（即签发token sourceid）            |
| tosourceid          | 2    | string | 可选   | 目的sourceid（即被登录业务sourceid）               |

</br>

### 3.1.3. 示例

**请求示例**

```
{
        "header": {
            "strictcheck":"0",
            "version": "1.0",
            "msgid": "40a940a940a940a93b8d3b8d3b8d3b8d",
            "systemtime": "20170515090923489",
            "appid": "10000001",
            "apptype": "5"
        },
        "body": {
            "token": "8484010001320200344E6A5A4551554D784F444E474E446C434E446779517A673340687474703A2F2F3139322E3136382E31322E3233363A393039302F0300040353EA68040006313030303030FF00203A020A143C6703D7D0530953C760744C7D61F5F7B546F12BC17D65254878748C"
        }
}
```

**响应示例**

```
{
         "header": {
            "inresponseto": "40a940a940a940a93b8d3b8d3b8d3b8d",
            "resultcode": "103000",
            "systemtime": "20170522204845598",
            "version": "1.0"
        },
        "body": {
            "msisdntype": "0",
            "usessionid": "NjZEQUMxODNGNDlCNDgyQzg3@http://192.168.12.236:9090/",
            "openid": "000000000",
            "loginidtype": "0",
            "authtime": "2017-05-22 20:48:45",
            "msisdn": "13683329795",
            "lastactivetime": "",
            "authtype": "WAPGW",
            "relateToAndPassport": "1"
        }
}
```

<div STYLE="page-break-after: always;"></div>

# 4. 返回码说明

## 4.1. SDK返回码

使用SDK时，SDK会在认证结束后将结果回调给开发者，其中结果为JSONObject对象，其中resultCode为结果响应码，102000代表成功，其他为失败。成功时在根据token字段取出身份标识。失败时根据resultCode定位失败原因。

| 错误编号   | 返回码描述                                    |
| ------ | ---------------------------------------- |
| 102000 | 成功                                       |
| 102101 | 无网络                                      |
| 102102 | 网络异常                                     |
| 102103 | 非移动网络                                    |
| 102109 | 网络错误                                     |
| 102201 | 自动登陆失败，用户选择自定义界面时，需要继续处理手动登陆流程，比如弹出登陆界面。 |
| 102202 | APP签名验证不通过                               |
| 102203 | 接口入参错误                                   |
| 102204 | 正在进行GetToken动作，请稍后                       |
| 102205 | 当前环境不支持指定的登陆方式                           |
| 102206 | 选择用户登陆时，本地不存在指定的用户                       |
| 102207 | 获取的中间件值错误                                |
| 102208 | 参数错误                                     |
| 102209 | 没有sim卡                                   |
| 102210 | 不支持短信发送                                  |
| 10299  | 其他错误                                     |
| 102301 | 用户取消                                     |
| 102302 | 没有进行初始化参数                                |
| 102303 | 用户名为空                                    |
| 102304 | 密码为空                                     |
| 102305 | 验证码获得成功                                  |
| 102306 | 验证码获得失败                                  |
| 102307 | 用户名格式错误                                  |
| 102308 | 用户名格式错误                                  |
| 102309 | 验证码格式错误                                  |
| 102310 | 用户名和验证码格式错误                              |
| 102311 | 密码格式错误                                   |
| 102312 | 用户名和密码格式错误                               |

</br>

## 4.2. 平台返回码

| 错误编号   | 返回码描述                |
| ------ | -------------------- |
| 103000 | 成功                   |
| 103101 | 签名错误                 |
| 103103 | 用户不存在                |
| 103104 | 用户不支持该种登录方式          |
| 103105 | 密码错误                 |
| 103106 | 用户名错误                |
| 103107 | 已存在相同的随机数            |
| 103108 | 短信验证码错误              |
| 103109 | 短信验证码超时              |
| 103111 | WAP网关IP不合法           |
| 103112 | 请求错误 reqError        |
| 103113 | Token内容错误            |
| 103114 | token验证 KS过期         |
| 103115 | token验证 KS不存在        |
| 103116 | token验证 sqn错误        |
| 103117 | mac异常 macError       |
| 103118 | sourceid不存在          |
| 103119 | appid不存在appidNOExist |
| 103120 | clientauth不存在        |
| 103121 | openid不存在            |
| 103122 | btid不存在              |
| 103123 | redisinfo不存在         |
| 103124 | ksnaf校验不一致           |
| 103125 | 手机格式错误               |
| 103126 | 手机号不存在               |
| 103127 | 证书验证，版本过期            |
| 103128 | gba webservice接口调用失败 |
| 103129 | 获取短信验证码的msgtype异常    |
| 103130 | 新密码不能与当前密码相同         |
| 103131 | 密码过于简单               |
| 103132 | 用户注册失败               |
| 103133 | sourceid不合法          |
| 103134 | wap方式手机号为空           |
| 103135 | 昵称非法                 |
| 103136 | 邮箱非法                 |
| 103138 | appid已存在             |
| 103139 | sourceid已存在          |
| 103200 | 不需要更新ks              |
| 103204 | 缓存随机数不存在             |
| 103205 | 服务器内部异常              |
| 103207 | 发送短信失败               |
| 103212 | 校验密码失败               |
| 103213 | 旧密码错误                |
| 103214 | 访问缓存或数据库错误           |
| 103226 | sqn过小或过大             |
| 103265 | 用户已存在                |
| 103901 | 短信验证码下发次数已达上限        |
| 103902 | 凭证校验失败               |
| 104001 | APPID和APPKEY已存在      |
| 105001 | 联通网关取号失败             |
| 105002 | 移动网关取号失败             |
| 105003 | 电信网关取号失败             |
| 105004 | 短信上行ip检测不合法          |
| 105005 | 短信上行发送信息为空           |
| 105006 | 手机号码为空               |
| 105007 | 手机号码格式错误             |
| 105008 | 短信内容为空               |
| 105009 | 解析失败                 |
